import logging
import asyncio
import re
from aiogram import Bot, Dispatcher, types
from aiogram.types import Message
from aiogram import executor

# Replace YOUR_BOT_TOKEN with your bot token obtained from BotFather
API_TOKEN = '6272908545:AAFG4g85gUbR2MpKU8frgIUWy4KqS8ZcFBo'

# Configure logging
logging.basicConfig(level=logging.INFO)

# Initialize bot and dispatcher
bot = Bot(token=API_TOKEN)
dp = Dispatcher(bot)


def split_text(text):
  words = text.split(' ')
  first_half = ' '.join(words[:30])

  # If the first half contains a period and it's before the 15th word,
  # find the last period before the 15th word and use that as the endpoint
  if '.' in first_half and first_half.index('.') < 15:
    for i in range(14, 0, -1):
      if words[i].endswith('.'):
        first_half = ' '.join(words[:i + 1])
        break

  second_half = ' '.join(words[len(first_half.split()):])

  # If the second half starts with a space, remove it
  if second_half.startswith(' '):
    second_half = second_half[1:]

  # If the first half ends on a word that's also in the second half,
  # move the endpoint of the first half to the previous sentence
  if len(second_half) > 0 and first_half.split()[-1] in second_half.split():
    for i in range(len(first_half.split()) - 2, 0, -1):
      if first_half.split()[i].endswith('.'):
        first_half = ' '.join(words[:i + 1])
        second_half = ' '.join(words[len(first_half.split()):])
        if second_half.startswith(' '):
          second_half = second_half[1:]
        break

  second_half = second_half.replace(
    '\n\n', '\n')  # replace double new lines with single new lines

  return (first_half, second_half)


@dp.message_handler()
async def start_command(message: Message):
  text = message.text.strip()

  words = []  # default value for words

  if 'therefore' in text.lower():
    # Split the input at 'therefore'
    parts = text.lower().split('therefore')
    # Get the first part
    first_part = parts[0].strip()
    # Get the first sentence in the second part
    second_part_sentences = parts[1].split('.')
    first_sentence = second_part_sentences[0].strip() + '.'
    # Get the remaining sentences in the second part
    remaining_sentences = '.'.join(second_part_sentences[1:]).strip()
    # Combine the first part and remaining sentences in the second part
    second_part = first_part + ' ' + remaining_sentences

    # Capitalize the first letter of the first sentence if necessary
    first_sentence = first_sentence.lstrip(',:;./\\').strip()
    first_sentence = first_sentence[0].upper(
    ) + first_sentence[1:] if first_sentence[0].islower() else first_sentence

    # Combine the first sentence and the remaining sentences in the second part
    first_half = first_sentence
    second_half = second_part.replace(
      '\n\n', '\n')  # replace double new lines with single new lines
  else:
    first_half, second_half = split_text(text)

  # Define the result variable here
  result = ""

  result += f"{first_half}\n\n"
  if second_half:
    result += f"{second_half}\n\n"
    
  # Check if any word in the dictionary appears in the message
  found_word = False
  for word in dictionary:
    if word.lower() in text.lower():
      found_word = True
      # Replace the entire message with a bold version of the message
      text = text.replace(word, f'<a href="{dictionary[word]}"><u>{word}</u></a>', 1)
      break
      
  if not found_word and len(words) > 30:
    first_word = list(dictionary.keys())[0]
    result += f"Learn more about {first_word} here: \n {dictionary[first_word]} \n\n #SPJ11"
  elif found_word:
    first_word = list(
      filter(lambda w: w.lower() in text.lower(), dictionary.keys()))[0]
    result += f"Learn more about {first_word} here: \n{dictionary[first_word]} \n\n #SPJ11"
  else:
    first_word = list(dictionary.keys())[0]
    result += f"Learn more about {first_word} here: \n {dictionary[first_word]} \n\n #SPJ11"
    
  await message.reply(result, parse_mode="HTML")


# Define dictionary of words and links
dictionary = {
  "word1": "https://example.com/word1",
  "word2": "https://example.com/word2",
  "liquid": "https://example.com/word3"
}

if __name__ == '__main__':
  executor.start_polling(dp, skip_updates=False)
